export class MIDIPlayer{soundFontURL="https://soundfonts.pages.dev/GeneralUser_GS_v1.471";midy;timer;currentTime=0;currTimeInterval=100;currTimeNode;totalTimeNode;seekBarNode;playNode;pauseNode;resumeNode;stopNode;constructor(e){this.midy=e,this.root=document.createElement("midi-player")}defaultLayout(){const e=this.row();e.appendChild(this.playPauseResume()),e.appendChild(this.volume()),e.appendChild(this.currTimeTotalTime()),e.appendChild(this.seekBar())}row(){const e=document.createElement("div");return e.className="midi-player-row",e.style.display="flex",e.style.alignItems="center",this.root.appendChild(e),e}formatTime(e){e=Math.floor(e);const n=e%60,t=(e-n)/60,s=(e-n-60*t)/3600,o=String(n).padStart(2,"0"),i=t>9||!s?`${t}:`:`0${t}:`,a=s?`${s}:`:"";return`${a}${i}${o}`}button(e,t,n,s){const o=document.createElement("div");return o.style.display=s,o.innerHTML=`
<button title="${e}" class="midi-player-btn ${t}" type="button">
  ${n}
</button>
`,o}formRange(e,t,n,s){const o=document.createElement("div");return o.innerHTML=`
<input title="${e}" class="midi-player-range ${t}" style="display:${s};"
  type="range" min="0" max="1" step="0.001" value="${n}">
`,o.firstElementChild}text(e,t){const n=document.createElement("div");return n.className=`midi-player-text ${t}`,n.textContent=e,n}startTimer(){const e=this.midy.totalTime;this.timer=setInterval(()=>{const t=this.midy.currentTime(),n=Math.ceil(t);this.currTimeNode&&(this.currTimeNode.textContent=this.formatTime(n)),this.seekBarNode&&(this.seekBarNode.value=t/e)},this.currTimeInterval)}async loadMIDI(e){await this.midy.loadMIDI(e),this.totalTimeNode&&(this.totalTimeNode.textContent=this.formatTime(this.midy.totalTime))}setSoundFontDir(e){this.soundFontURL=e}getSoundFontPaths(){const e=[],{midy:t,soundFontURL:n}=this;for(const i of t.instruments){const[a,s]=i.split(":"),o=Number(a),r=Number(s),c=t.soundFontTable[r][o];if(c!==void 0)continue;const l=o===128?"128":s;e.push(`${n}/${l}.sf3`)}return e}async start(){const e=this.midy;if(e.soundFonts.length===0){const t=this.getSoundFontPaths();await e.loadSoundFont(t)}this.startTimer(),await e.start(),clearInterval(this.timer),!e.isPaused&&this.currTimeNode&&(this.currTimeNode.textContent="0:00",this.seekBarNode.value=0)}async handleStop(){const e=this.midy;if(!e.isPlaying)return;clearInterval(this.timer),this.playNode.style.display="initial",this.pauseNode.style.display="none",this.resumeNode.style.display="none",await e.stop()}stop(){const e=this.button("start","midi-player-start","stop","initial");return e.onclick=()=>this.handleStop(),this.stopNode=e,e}async handlePlay(){const{midy:e,playNode:t,pauseNode:n}=this;if(e.isPlaying||e.isPaused)return;t.style.display="none",n.style.display="initial",await this.start(),e.isPaused||(n.style.display="none",t.style.display="initial")}handlePause(){const e=this.midy;if(!e.isPlaying||e.isPaused)return;this.pauseNode.style.display="none",this.resumeNode.style.display="initial",clearInterval(this.timer),e.pause()}async handleResume(){const{midy:e,playNode:n,pauseNode:t,resumeNode:s}=this;if(!e.isPaused)return;t.style.display="initial",s.style.display="none",this.startTimer(),await e.resume(),clearInterval(this.timer),e.isPaused||(t.style.display="none",n.style.display="initial")}playPauseResume(){const t=this.button("start","midi-player-start","play_arrow","initial"),n=this.button("pause","midi-player-pause","pause","none"),s=this.button("resume","midi-player-resume","play_arrow","none");this.playNode=t,this.pauseNode=n,this.resumeNode=s,t.onclick=()=>this.handlePlay(),n.onclick=()=>this.handlePause(),s.onclick=()=>this.handleResume();const e=document.createElement("div");return e.style.display="flex",e.style.alignItems="center",e.appendChild(t),e.appendChild(n),e.appendChild(s),e}volumeText(){return this.text("volume","midi-player-volumeText")}volume(){const t=this.button("mute ON","midi-player-muteOn","volume_down","initial"),n=this.button("mute OFF","midi-player-muteOff","volume_off","none"),s=this.formRange("volume","midi-player-volume",1,"none");t.onclick=()=>{t.style.display="none",n.style.display="initial",this.midy.setMasterVolume(0)},n.onclick=()=>{t.style.display="initial",n.style.display="none",this.midy.setMasterVolume(1)},s.oninput=e=>{this.midy.setMasterVolume(e.target.value)};const e=document.createElement("div");return e.style.display="flex",e.style.alignItems="center",e.appendChild(t),e.appendChild(n),e.appendChild(s),e.onmouseover=()=>{s.style.display="initial"},e.onmouseout=()=>{s.style.display="none"},e}seekBar(){const e=this.formRange("playback position","midi-player-seekBar",0,"initial");return e.oninput=e=>{const t=e.target.value*this.midy.totalTime;this.midy.seekTo(t),this.currTimeNode&&(this.currTimeNode.textContent=this.formatTime(t))},this.seekBarNode=e,e}currTime(){const e=this.text("0:00","midi-player-currTime");return this.currTimeNode=e,e}totalTime(){const e=this.text("0:00","midi-player-totalTime");return this.totalTimeNode=e,e}currTimeTotalTime(){const t=this.currTime(),n=this.text("/","midi-player-timeSeparator"),s=this.totalTime(),e=document.createElement("div");return e.style.display="flex",e.style.alignItems="center",e.appendChild(t),e.appendChild(n),e.appendChild(s),e}}