export class MIDIPlayer{soundFontURL="https://soundfonts.pages.dev/GeneralUser_GS_v1.471";midy;timer;currentTime=0;currTimeInterval=100;currTimeNode;totalTimeNode;seekBarNode;playNode;pauseNode;resumeNode;stopNode;isPlaying=!1;isPausing=!1;isPaused=!1;isStopping=!1;isSeeking=!1;constructor(e){this.midy=e,this.root=document.createElement("midi-player")}defaultLayout(){const e=this.row();e.appendChild(this.playPauseResume()),e.appendChild(this.volume()),e.appendChild(this.repeat()),e.appendChild(this.speed()),e.appendChild(this.currTimeTotalTime()),e.appendChild(this.seekBar())}row(){const e=document.createElement("div");return e.className="midi-player-row",e.style.display="flex",e.style.alignItems="center",this.root.appendChild(e),e}formatTime(e){e=Math.floor(e);const n=e%60,t=(e-n)/60,s=(e-n-60*t)/3600,o=String(n).padStart(2,"0"),i=t>9||!s?`${t}:`:`0${t}:`,a=s?`${s}:`:"";return`${a}${i}${o}`}button(e,t,n,s){const o=document.createElement("div");return o.style.display=s,o.innerHTML=`
<button title="${e}" class="midi-player-btn ${t}" type="button">
  ${n}
</button>
`,o}formRange(e,t,n,s){const o=document.createElement("div");return o.innerHTML=`
<input title="${e}" class="midi-player-range ${t}" style="display:${s};"
  type="range" min="0" max="1" step="0.001" value="${n}">
`,o.firstElementChild}text(e,t){const n=document.createElement("div");return n.className=`midi-player-text ${t}`,n.textContent=e,n}startTimer(){const t=this.midy.totalTime;this.stopTimer();const e=()=>{const n=this.midy.currentTime();if(this.currTimeNode){const e=Math.ceil(n);this.currTimeNode.textContent=this.formatTime(e)}this.seekBarNode&&(this.seekBarNode.value=n/t),this.timer=requestAnimationFrame(e)};this.timer=requestAnimationFrame(e)}stopTimer(){this.timer&&(cancelAnimationFrame(this.timer),this.timer=null)}async loadMIDI(e){await this.midy.loadMIDI(e),this.totalTimeNode&&(this.totalTimeNode.textContent=this.formatTime(this.midy.totalTime))}setSoundFontDir(e){this.soundFontURL=e}getSoundFontPaths(){const e=[],{midy:t,soundFontURL:n}=this;for(const i of t.instruments){const[a,s]=i.split(":"),o=Number(a),r=Number(s),c=t.soundFontTable[r][o];if(c!==void 0)continue;const l=o===128?"128":s;e.push(`${n}/${l}.sf3`)}return e}async start(){this.isPlaying=!0;const e=this.midy;await e.loadSoundFont(this.getSoundFontPaths()),this.startTimer(),await e.start(),this.stopTimer(),this.isPlaying=!1,!e.isPaused&&this.currTimeNode&&(this.currTimeNode.textContent="0:00",this.seekBarNode.value=0)}async handleStop(){const e=this.midy;if(!e.isPlaying)return;this.isStopping=!0,this.playNode.style.display="initial",this.pauseNode.style.display="none",this.resumeNode.style.display="none",this.stopTimer(),await e.stop(),this.isPlaying=!1}stop(){const e=this.button("start","midi-player-start","stop","initial");return e.onclick=()=>this.handleStop(),this.stopNode=e,e}async handlePlay(){const{midy:e,playNode:t,pauseNode:n}=this;if(e.isPlaying||e.isPaused)return;this.isPlaying=!0,t.style.display="none",n.style.display="initial",await this.start(),this.isPlaying=!1,e.isPaused||(n.style.display="none",t.style.display="initial")}async handlePause(){const e=this.midy;if(!e.isPlaying||e.isPaused)return;this.isPausing=!0,this.pauseNode.style.display="none",this.resumeNode.style.display="initial",this.stopTimer(),await e.pause(),this.isPausing=!1,this.isPaused=!0}async handleResume(){const{midy:e,playNode:n,pauseNode:t,resumeNode:s}=this;if(!e.isPaused)return;this.isPlaying=!0,t.style.display="initial",s.style.display="none",this.startTimer(),await e.resume(),this.stopTimer(),this.isPlaying=!1,e.isPaused||(t.style.display="none",n.style.display="initial")}playPauseResume(){const t=this.button("start","midi-player-start","play_arrow","initial"),n=this.button("pause","midi-player-pause","pause","none"),s=this.button("resume","midi-player-resume","play_arrow","none");this.playNode=t,this.pauseNode=n,this.resumeNode=s,t.onclick=()=>this.handlePlay(),n.onclick=()=>this.handlePause(),s.onclick=()=>this.handleResume();const e=document.createElement("div");return e.style.display="flex",e.style.alignItems="center",e.appendChild(t),e.appendChild(n),e.appendChild(s),e}volumeText(){return this.text("volume","midi-player-volumeText")}volume(){const n=this.button("mute ON","midi-player-muteOn","volume_down","initial"),s=this.button("mute OFF","midi-player-muteOff","volume_off","none"),t=this.formRange("volume","midi-player-volume",100/128,"none");n.onclick=()=>{n.style.display="none",s.style.display="initial",this.midy.setMasterVolume(0)},s.onclick=()=>{n.style.display="initial",s.style.display="none",this.midy.setMasterVolume(Number(t.value))},t.oninput=e=>{this.midy.setMasterVolume(e.target.value)};const e=document.createElement("div");return e.style.display="flex",e.style.alignItems="center",e.appendChild(n),e.appendChild(s),e.appendChild(t),e.onmouseover=()=>{t.style.display="initial"},e.onmouseout=()=>{t.style.display="none"},e}speed(){const n=this.button("reset speed","midi-player-speed","speed","initial"),t=this.formRange("playback speed","midi-player-speed",.5,"none");n.onclick=()=>{t.value=.5,this.midy.tempoChange(1),this.stopTimer(),this.startTimer(),this.totalTimeNode&&(this.totalTimeNode.textContent=this.formatTime(this.midy.totalTime))},t.onchange=e=>{const n=Number(e.target.value),t=.5,s=2,o=t*Math.pow(s/t,n);this.midy.tempoChange(o),this.stopTimer(),this.startTimer(),this.totalTimeNode&&(this.totalTimeNode.textContent=this.formatTime(this.midy.totalTime))};const e=document.createElement("div");return e.style.display="flex",e.style.alignItems="center",e.appendChild(n),e.appendChild(t),e.onmouseover=()=>{t.style.display="initial"},e.onmouseout=()=>{t.style.display="none"},e}repeat(){const t=this.button("repeat ON","midi-player-repeatOn","turn_right","initial"),n=this.button("repeat OFF","midi-player-repeatOff","repeat","none");t.onclick=()=>{t.style.display="none",n.style.display="initial",this.midy.loop=!0},n.onclick=()=>{t.style.display="initial",n.style.display="none",this.midy.loop=!1};const e=document.createElement("div");return e.style.display="flex",e.style.alignItems="center",e.appendChild(t),e.appendChild(n),e}seekBar(){const e=this.formRange("playback position","midi-player-seekBar",0,"initial");return e.oninput=e=>{this.isSeeking=!0;const t=e.target.value*this.midy.totalTime;this.midy.seekTo(t),this.currTimeNode&&(this.currTimeNode.textContent=this.formatTime(t)),this.isSeeking=!1},this.seekBarNode=e,e}currTime(){const e=this.text("0:00","midi-player-currTime");return this.currTimeNode=e,e}totalTime(){const e=this.text("0:00","midi-player-totalTime");return this.totalTimeNode=e,e}currTimeTotalTime(){const t=this.currTime(),n=this.text("/","midi-player-timeSeparator"),s=this.totalTime(),e=document.createElement("div");return e.style.display="flex",e.style.alignItems="center",e.appendChild(t),e.appendChild(n),e.appendChild(s),e}}